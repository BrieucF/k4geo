###################################################################################################
#
#  DDSim package ILD
#   port of the Mokka ILD model(s) to DD4hep
#
# F.Gaede, DESY, 2013
###################################################################################################

The goal of this package is to preserve the current Mokka models for DD4hep.

The current status is 'highly experimental' as we are trying to understand how to best 
go about the porting. 

The following is a loose set of notes of commands and scripts used for the
first port of the ILD_o1_v05 detector model...



####################################################################################################
# browse the Mokka DB:
#
mysql -h pollin1.in2p3.fr -u consult -p

mysql> select ingredients.sub_detector, sub_detector.driver, sub_detector.subdriver, db, build_order from ingredients,sub_detector where (ingredients.model="ILD_o1_v05" and ingredients.sub_detector=sub_detector.name ) ;
+------------------------------+----------------------+------------+------------------------------+-------------+
| sub_detector                 | driver               | subdriver  | db                           | build_order |
+------------------------------+----------------------+------------+------------------------------+-------------+
| LHcal01                      | SLHcal01             |            | VOID                         |         120 |
| tpc10_01                     | tpc10                |            | tpc10_01                     |         200 |
| ftd_simple_staggered_02      | FTD_Simple_Staggered |            | ftd_simple_staggered_02      |         220 |
| SEcal03p01                   | SEcal04              |            | VOID                         |          90 |
| SHcalSc03                    | SHcalSc03            |            | VOID                         |         110 |
| SCoil03                      | SCoil02              | coil01     | VOID                         |         400 |
| yoke05                       | yoke05               |            | yoke04                       |         500 |
| LumiCalV                     | SLcal03              | LumiCalV00 | VOID                         |         100 |
| tubeX06                      | tubeX01              |            | tubeX06                      |         150 |
| sit_simple_planar_sensors_03 | SIT_Simple_Planar    |            | sit_simple_planar_sensors_03 |         210 |
| SField01                     | SField01             | field00    | VOID                         |        1000 |
| vxd07                        | SVxd04               | vxd04      | vxd07                        |          20 |
| set_simple_planar_sensors_01 | SET_Simple_Planar    |            | set_simple_planar_sensors_01 |         230 |
| maskX03                      | maskX01              |            | maskX03                      |         160 |
| BeamCal08                    | BeamCal01            |            | beamcalX08                   |         650 |
| SServices00                  | SServices00          |            | VOID                         |        1200 |
+------------------------------+----------------------+------------+------------------------------+-------------+


######################################################################################################
#
#  modified MySQLWrapper to create xml files (per database) with all parameters from select commands:

 TMP_DB07.xml
 beamcalX08.xml
 ftd_simple_staggered_02.xml
 hcal04.xml
 maskX03_14.xml
 materials02.xml
 models03.xml
 set_simple_planar_sensors_01.xml
 sit_simple_planar_sensors_03.xml
 tpc10_01.xml
 tubeX06_14.xml
 yoke04.xml


######################################################################################################
#
# create a gdml dump of the Mokka model
#
Mokka -M ILD_o1_v05

/Mokka/Visu/Detector/DumpGDML
exit

mv World.gdml ILD_o1_v05.gdml


#
# create materials.xml file:
#    - extract <materials/> block into TMP file
#      and remove hex numbers from names:

sed 's/0x[abcdef0-9]*//' materials_TMP.xml > materials.xml

######################################################################################################
#
#  select global parameters used by the model (and superdrivers)
#

mysql> select sub_detector.driver, sharing.parameter, sharing.driver_default_value from ingredients,sub_detector,sharing where (ingredients.model="ILD_o1_v05" and ingredients.sub_detector=sub_detector.name and sharing.driver=sub_detector.driver and sharing.driver_default_value IS NOT NULL) ;
+----------------------+----------------------------------+----------------------+
| driver               | parameter                        | driver_default_value |
+----------------------+----------------------------------+----------------------+
| FTD_Simple_Staggered | TUBE_IPOuterTube_start_z         | 150                  |
| FTD_Simple_Staggered | TUBE_IPOuterTube_start_radius    | 24                   |
| FTD_Simple_Staggered | TUBE_IPOuterTube_end_z           | 230                  |
| FTD_Simple_Staggered | TUBE_IPOuterTube_end_radius      | 24                   |
| FTD_Simple_Staggered | TUBE_IPOuterBulge_end_z          | 2364.5               |
| FTD_Simple_Staggered | TUBE_IPOuterBulge_end_radius     | 184                  |
| FTD_Simple_Staggered | TPC_inner_radius                 | 329                  |
| FTD_Simple_Staggered | TPC_Ecal_Hcal_barrel_halfZ       | 2350                 |
| FTD_Simple_Staggered | SIT2_Radius                      | 272.363              |
| FTD_Simple_Staggered | SIT2_Half_Length_Z               | 672.35               |
| FTD_Simple_Staggered | SIT1_Radius                      | 179.232              |
| SEcal04              | Ecal_Alveolus_Air_Gap            | 0.5                  |
| SEcal04              | Ecal_Slab_shielding              | 0.1                  |
| SEcal04              | Ecal_Slab_copper_thickness       | 0.4                  |
| SEcal04              | Ecal_Slab_PCB_thickness          | 0.8                  |
| SEcal04              | Ecal_Slab_glue_gap               | 0.1                  |
| SEcal04              | Ecal_Slab_ground_thickness       | 0.1                  |
| SEcal04              | Ecal_barrel_number_of_towers     | 5                    |
| SEcal04              | Ecal_Barrel_halfZ                | 2288                 |
| SEcal04              | Ecal_guard_ring_size             | 0.5                  |
| SEcal04              | Ecal_front_face_thickness        | 2                    |
| SEcal04              | Ecal_lateral_face_thickness      | 2                    |
| SEcal04              | Ecal_fiber_thickness             | .15                  |
| SEcal04              | Ecal_Si_thickness                | .5                   |
| SEcal04              | Ecal_cells_size                  | 4.9                  |
| SEcal04              | Ecal_endcap_center_box_size      | 800.0                |
| SEcal04              | Ecal_endcap_extra_size           | 71.22                |
| SEcal04              | Ecal_nlayers2                    | 9                    |
| SEcal04              | Ecal_Slab_H_fiber_thickness      | 0.55                 |
| SEcal04              | TUBE_crossing_angle              |                      |
| SHcalSc03            | Hcal_Ecal_gap                    | 30                   |
| SHcalSc03            | Hcal_apply_Birks_law             | 1                    |
| SHcalSc03            | Hcal_back_plate_thickness        | 15                   |
| SHcalSc03            | Hcal_cells_size                  | 30                   |
| SHcalSc03            | Hcal_endcap_nlayers              | 48                   |
| SHcalSc03            | Hcal_endcap_center_box_size      | 700.0                |
| SHcalSc03            | Hcal_endcap_radiator_material    | Iron                 |
| SHcalSc03            | Hcal_endcap_radiator_thickness   | 20                   |
| SHcalSc03            | Hcal_endcap_sensitive_center_box | 0.0                  |
| SHcalSc03            | Hcal_lateral_structure_thickness | 15                   |
| SHcalSc03            | Hcal_layer_air_gap               | 2                    |
| SHcalSc03            | Hcal_layer_support_length        | 0                    |
| SHcalSc03            | Hcal_middle_stave_gaps           | 10                   |
| SHcalSc03            | Hcal_modules_gap                 | 0                    |
| SHcalSc03            | Hcal_nlayers                     | 48                   |
| SHcalSc03            | Hcal_radiator_thickness          | 20                   |
| SHcalSc03            | Hcal_sensitive_model             | scintillator         |
| SHcalSc03            | Hcal_stave_gaps                  | 10                   |
| SHcalSc03            | Hcal_fiber_gap                   | 1.7                  |
| BeamCal01            | LHcal_zend                       | 3085                 |
| BeamCal01            | BCal_TubeIncomingRadius          | 15                   |
| BeamCal01            | BCal_rInner                      | 20                   |
| BeamCal01            | BCal_rOuter                      | 150                  |
| BeamCal01            | BCal_nLayers                     | 30                   |
| BeamCal01            | BCal_PairMonitor                 | 1                    |
| BeamCal01            | BCal_dAbsorber                   | 3.5                  |
| BeamCal01            | BCal_dGraphite                   | 100                  |
| BeamCal01            | BCal_rSegmentation               | 8                    |
| BeamCal01            | BCal_nWafers                     | 8                    |
| BeamCal01            | BCal_SpanningPhi                 | 320                  |
| BeamCal01            | LHcal_BCal_clearance             | 390                  |
| SServices00          | Hcal_radiator_thickness          | 20.0                 |
| FTD_Simple_Staggered | SIT1_Half_Length_Z               | 384.2                |
| FTD_Simple_Staggered | Ecal_endcap_zmin                 | 2450.0               |
| FTD_Simple_Staggered | VXD_length_r3                    | 125                  |
| SServices00          | TUBE_IPOuterBulge_end_radius     | 184                  |
| SServices00          | TUBE_IPOuterBulge_end_z          | 2364.5               |
| SServices00          | SIT1_Radius                      | 179.232              |
| SServices00          | SIT2_Radius                      | 272.363              |
+----------------------+----------------------------------+----------------------+
69 rows in set (0.05 sec)



mysql> select * from model_parameters where model="ILD_o1_v05" ;
+------------+----------------------------------+---------------+
| model      | parameter                        | default_value |
+------------+----------------------------------+---------------+
| ILD_o1_v05 | Coil_extra_size                  | 1522          |
| ILD_o1_v05 | Coil_Yoke_radial_clearance       | 250           |
| ILD_o1_v05 | Ecal_Barrel_halfZ                | 2350          |
| ILD_o1_v05 | Ecal_endcap_extra_size           | 60.8          |
| ILD_o1_v05 | Ecal_support_thickness           | 9.3           |
| ILD_o1_v05 | Ecal_Tpc_gap                     | 35            |
| ILD_o1_v05 | Field_nominal_value              | 3.5           |
| ILD_o1_v05 | Hcal_back_plate_thickness        | 15            |
| ILD_o1_v05 | Hcal_Coil_additional_gap         | 29.5          |
| ILD_o1_v05 | Hcal_Ecal_gap                    | 30            |
| ILD_o1_v05 | Hcal_endcap_center_box_size      | 700.0         |
| ILD_o1_v05 | Hcal_endcap_ecal_gap             | 15            |
| ILD_o1_v05 | Hcal_endcap_sensitive_center_box | 0.0           |
| ILD_o1_v05 | Hcal_endcap_zmin                 | 2670.7        |
| ILD_o1_v05 | Hcal_fiber_gap                   | 2.7           |
| ILD_o1_v05 | Hcal_nlayers                     | 48            |
| ILD_o1_v05 | Hcal_sensitive_model             | scintillator  |
| ILD_o1_v05 | ILC_Main_Crossing_Angle          | 14            |
| ILD_o1_v05 | Lcal_inner_radius                | 80.0          |
| ILD_o1_v05 | Lcal_outer_radius                | 195.2         |
| ILD_o1_v05 | Lcal_z_begin                     | 2505.0        |
| ILD_o1_v05 | Lcal_z_thickness                 | 135.6         |
| ILD_o1_v05 | TPC_inner_radius                 | 329           |
| ILD_o1_v05 | TPC_outer_radius                 | 1808          |
| ILD_o1_v05 | TUBE_crossing_angle              | 14            |
| ILD_o1_v05 | TUBE_opening_angle               | 0.07876       |
| ILD_o1_v05 | VXD_active_silicon_thickness     | 0.05          |
| ILD_o1_v05 | VXD_inner_radius                 | 16            |
| ILD_o1_v05 | VXD_length_r1                    | 62.5          |
| ILD_o1_v05 | VXD_radius_r1                    | 16            |
| ILD_o1_v05 | VXD_radius_r3                    | 37            |
| ILD_o1_v05 | VXD_radius_r5                    | 58            |
| ILD_o1_v05 | VXD_side_band_electronics_width  | 0.5           |
| ILD_o1_v05 | VXD_support_ladder_material      | "graphite"    |
| ILD_o1_v05 | VXD_support_ladder_thickness     | 0.134         |
| ILD_o1_v05 | Yoke_endcap_inner_radius         | 300           |
| ILD_o1_v05 | Yoke_thickness                   | 2550          |
+------------+----------------------------------+---------------+
37 rows in set (0.03 sec)




##########################################################################################################################################################################################################
#
#  python script to create <constant name value/> elements of all parameters for a given model:
#

#!/usr/bin/python
import MySQLdb

db = MySQLdb.connect(host="pollin1.in2p3.fr", # your host, usually localhost
                     user="consult", # your username
                     passwd="consult", # your password
                     db="models03") # name of the data base

model="ILD_o1_v05"

# you must create a Cursor object. It will let
#  you execute all the query you need
cur = db.cursor()

# Use all the SQL you like
cur.execute("select sub_detector.driver, sharing.parameter, sharing.driver_default_value from ingredients,sub_detector,sharing where (ingredients.model=\""+model+"\" and ingredients.sub_detector=sub_detector.name and sharing.driver=sub_detector.driver and sharing.driver_default_value IS NOT NULL) ;")

params = {}

# print all the first cell of all the rows
for row in cur.fetchall() :
    #print row[1], "  " , row[2]
    params[ row[1] ] = row[2]



cur.execute("select * from model_parameters where model=\""+model+"\" ;")

for row in cur.fetchall() :
    #print row[1], "  " , row[2]
    params[ row[1] ] = row[2]


print params

#for k,v in params.iteritems():

for k in sorted( params ):
   v = params[ k ]
   print "<constant name=\"" + k + "\" value=\"" + v + "\"/>"

##########################################################################################################################################################################################################
